<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm border-bottom">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="{{ url_for('main.index') }}">
            <div class="_bg-primary _bg-opacity-10 rounded-2 p-2 me-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                <img src="/static/postbot_logo.png" alt="PostBot" style="width:36px; height:36px;">
            </div>
            <span>PostBot</span>
        </a>

        <div class="d-flex align-items-center d-lg-none ms-auto">
            
            <button class="btn btn-link nav-link p-0 me-3 theme-toggle" 
                    type="button" 
                    title="Переключить тему"
                    data-bs-theme-value="dark">
                <i class="bi bi-moon-stars-fill fs-5"></i>
            </button>

            <button class="navbar-toggler border-0 p-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>

        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.index' %}active fw-semibold{% endif %}" href="{{ url_for('main.index') }}">
                        <i class="bi bi-house-door me-1"></i>Главная
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.analytics' %}active fw-semibold{% endif %}" href="{{ url_for('main.analytics') }}">
                        <i class="bi bi-graph-up me-1"></i>Аналитика
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'settings.social' %}active fw-semibold{% endif %}" href="{{ url_for('settings.social') }}">
                        <i class="bi bi-gear me-1"></i>Настройки
                    </a>
                </li>
                
                {% if current_user.is_admin %} 
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        <i class="bi bi-shield-check me-1"></i>Админ
                    </a>
                    <ul class="dropdown-menu border-0 shadow-sm">
                        <li>
                            <a class="dropdown-item py-2" href="{{ url_for('admin.dashboard') }}">
                                <i class="bi bi-speedometer2 me-2 text-primary"></i>Панель
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item py-2" href="{{ url_for('admin.settings_page') }}">
                                <i class="bi bi-sliders me-2"></i>Глобальные настройки
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item py-2" href="{{ url_for('admin.tariffs_list') }}">
                                <i class="bi bi-credit-card me-2 text-warning"></i>Тарифы
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item py-2" href="{{ url_for('admin.transactions_list') }}">
                                <i class="bi bi-list-columns-reverse me-2 text-success"></i>Транзакции
                            </a>
                        </li>
                         <li>
                            <a class="dropdown-item py-2" href="{{ url_for('admin.promocodes_list') }}">
                                <i class="bi bi-ticket-perforated me-2 text-info"></i>Промокоды
                            </a>
                        </li>
                    </ul>
                </li>
                {% endif %} 
            </ul>

            <div class="d-flex align-items-center gap-3">
                
                <button class="btn btn-light border-0 rounded-circle d-flex align-items-center justify-content-center me-2 theme-toggle" 
                        type="button"
                        title="Переключить тему"
                        data-bs-theme-value="dark"
                        style="width: 40px; height: 40px; transition: background-color 0.3s;">
                    <i class="bi bi-moon-stars-fill fs-5"></i>
                </button>           
                
                {% if current_user.is_authenticated and current_user.projects %}
                <div class="dropdown">
                    <button class="btn btn-light border dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-folder text-primary"></i>
                        <span class="d-none d-md-inline">{{ g.project.name if g.project else 'Выбрать проект' }}</span>
                        <span class="d-md-none">Проект</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="min-width: 240px;">
                        <li><h6 class="dropdown-header text-uppercase small text-muted">Ваши проекты</h6></li>
                        {% for proj in current_user.projects %}
                        <li>
                            <a class="dropdown-item d-flex justify-content-between align-items-center py-2" 
                               href="{{ url_for('settings.switch_project', project_id=proj.id) }}">
                                <span class="text-truncate" style="max-width: 180px;">{{ proj.name }}</span>
                                {% if g.project and g.project.id == proj.id %}
                                    <i class="bi bi-check-lg text-primary ms-2"></i>
                                {% endif %}
                            </a>
                        </li>
                        {% endfor %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-primary" href="#" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                                <i class="bi bi-plus-circle me-2"></i>Новый проект
                            </a>
                        </li>
                        <li>
                            {% if current_user.projects|length > 1 %}
                                <a class="dropdown-item py-2" href="#" onclick="return confirm('Удалить текущий проект «{{ g.project.name }}»? Это действие нельзя отменить!') 
                                ? window.location.href='{{ url_for('settings.delete_project', project_id=g.project.id) }}' : false;">
                                    <i class="bi bi-trash text-danger me-2"></i>Удалить проект
                                </a>
                            {% else %}
                                <span class="dropdown-item py-2 text-muted disabled" title="Нельзя удалить единственный проект">
                                    <i class="bi bi-trash me-2"></i>Удалить проект
                                </span>
                            {% endif %}
                        </li>       
                    </ul>
                </div>
                {% endif %}

                {% if current_user.is_authenticated %}
                <a href="{{ url_for('billing.topup') }}" class="btn btn-success btn-sm d-flex align-items-center gap-2">
                    <i class="bi bi-wallet2"></i>
                    <span class="fw-semibold">{{ (current_user.balance / 100) | round(2) }} ₽</span>
                    <i class="bi bi-plus-circle-fill ms-1 opacity-75"></i> 
                </a>

                <div class="dropdown">
                    <button class="btn btn-light border-0 rounded-circle d-flex align-items-center justify-content-center bg-light" 
                            type="button" data-bs-toggle="dropdown" 
                            style="width: 40px; height: 40px; font-weight: bold; color: var(--bs-primary);">
                        {{ current_user.email[0].upper() }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="min-width: 200px;">
                        <li class="px-3 py-2">
                            <div class="small text-muted">Вы вошли как</div>
                            <div class="fw-semibold text-truncate" style="max-width: 180px;">{{ current_user.email }}</div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item py-2" href="{{ url_for('settings.profile') }}">
                                <i class="bi bi-person-circle me-2 text-primary"></i>Мой профиль
                            </a>
                        </li>                       
                        <li>
                            <a class="dropdown-item py-2 text-danger" href="{{ url_for('auth.logout') }}">
                                <i class="bi bi-box-arrow-right me-2"></i>Выход
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold text-primary d-flex align-items-center" id="mobileMenuLabel">
            <i class="bi bi-robot me-2"></i>PostBot
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        {% if current_user.is_authenticated %}
            <div class="p-3 bg-light border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Текущий проект</span>
                    <span class="badge bg-primary">{{ current_user.projects|length }}</span>
                </div>
                <h6 class="mb-3 fw-semibold">{{ g.project.name if g.project else 'Не выбран' }}</h6>
                
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" onchange="if(this.value) window.location.href=this.value">
                        <option value="">Сменить проект...</option>
                        {% for proj in current_user.projects %}
                        <option value="{{ url_for('settings.switch_project', project_id=proj.id) }}" 
                                {% if g.project and g.project.id == proj.id %}selected disabled{% endif %}>
                            {{ proj.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>

            <div class="list-group list-group-flush">
                <a href="{{ url_for('main.index') }}" class="list-group-item list-group-item-action py-3">
                    <i class="bi bi-house-door me-3 text-primary"></i>Главная
                </a>
                <a href="{{ url_for('main.analytics') }}" class="list-group-item list-group-item-action py-3">
                    <i class="bi bi-graph-up me-3 text-success"></i>Аналитика
                </a>
                <a href="{{ url_for('settings.social') }}" class="list-group-item list-group-item-action py-3">
                    <i class="bi bi-gear me-3 text-secondary"></i>Настройки
                </a>
                
                {% if current_user.is_admin %}
                <div class="list-group-item py-0 border-0 p-0">
                    <a class="list-group-item-action py-3 d-flex align-items-center justify-content-between w-100 border-bottom px-3" 
                       data-bs-toggle="collapse" href="#mobileAdminCollapse" role="button" aria-expanded="false">
                        <span><i class="bi bi-shield-check me-3 text-warning"></i>Администрирование</span>
                        <i class="bi bi-chevron-down small"></i>
                    </a>
                    <div class="collapse bg-light border-bottom" id="mobileAdminCollapse">
                        <a href="{{ url_for('admin.dashboard') }}" class="list-group-item list-group-item-action py-2 ps-5 small border-0 bg-transparent">
                            <i class="bi bi-speedometer2 me-2"></i>Панель
                        </a>
                        <a href="{{ url_for('admin.settings_page') }}" class="list-group-item list-group-item-action py-2 ps-5 small border-0 bg-transparent">
                            <i class="bi bi-sliders me-2"></i>Настройки системы
                        </a>
                        <a href="{{ url_for('admin.tariffs_list') }}" class="list-group-item list-group-item-action py-2 ps-5 small border-0 bg-transparent">
                            <i class="bi bi-credit-card me-2"></i>Тарифы
                        </a>
                        <a href="{{ url_for('admin.transactions_list') }}" class="list-group-item list-group-item-action py-2 ps-5 small border-0 bg-transparent">
                            <i class="bi bi-list-columns-reverse me-2"></i>Транзакции
                        </a>
                         <a href="{{ url_for('admin.promocodes_list') }}" class="list-group-item list-group-item-action py-2 ps-5 small border-0 bg-transparent">
                            <i class="bi bi-ticket-perforated me-2"></i>Промокоды
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="p-3 bg-light mt-auto border-top">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 40px; height: 40px; font-weight: bold;">
                        {{ current_user.email[0].upper() }}
                    </div>
                    <div class="overflow-hidden">
                        <div class="fw-semibold text-truncate">{{ current_user.email }}</div>
                        <div class="small text-success fw-semibold">{{ (current_user.balance / 100) | round(2) }} ₽</div>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('billing.topup') }}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle me-2"></i>Пополнить баланс
                    </a>
                    <a href="{{ url_for('settings.profile') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-person-circle me-2"></i>Профиль
                    </a>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-box-arrow-right me-2"></i>Выйти
                    </a>
                </div>
            </div>
        {% else %}
            <div class="list-group list-group-flush">
                <a href="{{ url_for('auth.login') }}" class="list-group-item list-group-item-action py-3">
                    <i class="bi bi-box-arrow-in-right me-3 text-primary"></i>Вход
                </a>
                <a href="{{ url_for('auth.register') }}" class="list-group-item list-group-item-action py-3">
                    <i class="bi bi-person-plus me-3 text-success"></i>Регистрация
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% if current_user.is_authenticated %}
<div class="modal fade" id="newProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-folder-plus me-2 text-primary"></i>Новый проект
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('settings.create_project') }}" method="POST">
                <div class="modal-body pt-3">
                    <div class="mb-3">
                        <label for="projectName" class="form-label small fw-medium text-muted">Название проекта</label>
                        <input type="text" class="form-control form-control-lg" id="projectName" name="name" 
                               placeholder="Например: Мой блог" required autofocus>
                        <div class="form-text small">Проект объединяет посты, каналы и настройки</div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Создать проект
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.navbar-brand:hover {
    color: var(--bs-primary);
}
.dropdown-item:active {
    background-color: var(--bs-primary);
}
.offcanvas-start {
    width: 300px;
}
@media (max-width: 991px) {
    /* Не скрываем мобильную группу кнопок */
}
</style>

<script>
/*!
 * Color mode toggler for Bootstrap's docs (modified for PostBot)
 */
(() => {
  'use strict'

  const getStoredTheme = () => localStorage.getItem('theme')
  const setStoredTheme = theme => localStorage.setItem('theme', theme)

  const getPreferredTheme = () => {
    const storedTheme = getStoredTheme()
    if (storedTheme) {
      return storedTheme
    }
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  const setTheme = theme => {
    if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.setAttribute('data-bs-theme', 'dark')
    } else {
      document.documentElement.setAttribute('data-bs-theme', theme)
    }
  }

  setTheme(getPreferredTheme())

  const showActiveTheme = (theme) => {
    // Находим все кнопки переключения
    const themeSwitchers = document.querySelectorAll('.theme-toggle')

    themeSwitchers.forEach(themeSwitcher => {
      const themeIcon = themeSwitcher.querySelector('i')
      
      // Меняем иконку и значение data-bs-theme-value
      if (theme === 'dark') {
        themeIcon.className = 'bi bi-moon-stars-fill fs-5'
        themeSwitcher.setAttribute('data-bs-theme-value', 'light') // След. клик включит светлую
        themeSwitcher.setAttribute('title', 'Включить светлую тему')
      } else {
        themeIcon.className = 'bi bi-sun-fill fs-5'
        themeSwitcher.setAttribute('data-bs-theme-value', 'dark') // След. клик включит темную
        themeSwitcher.setAttribute('title', 'Включить темную тему')
      }
    })
  }

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const storedTheme = getStoredTheme()
    if (storedTheme !== 'light' && storedTheme !== 'dark') {
      setTheme(getPreferredTheme())
    }
  })

  window.addEventListener('DOMContentLoaded', () => {
    showActiveTheme(getPreferredTheme())

    document.querySelectorAll('.theme-toggle').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const currentTheme = getPreferredTheme()
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
        
        setStoredTheme(newTheme)
        setTheme(newTheme)
        showActiveTheme(newTheme)
      })
    })
  })
})()
</script>