{% extends "_base.html" %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-body py-3 border-bottom" style="z-index: 100; top: 0;">
        <div>
            <h2 class="fw-bold mb-0"><i class="bi bi-calendar-week me-2 text-primary"></i>–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –ª–µ–Ω—Ç–∞</h2>
            <div class="text-muted small">–ë–ª–∏–∂–∞–π—à–∞—è –Ω–µ–¥–µ–ª—è (¬±), –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</div>
        </div>

        <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#createPostModal">
            <i class="bi bi-plus-lg me-1"></i>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç
        </button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap gap-2 align-items-center">
            <button class="btn btn-outline-secondary btn-sm" id="btn-load-prev-week"><i class="bi bi-arrow-up"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</button>
            <button class="btn btn-outline-secondary btn-sm" id="btn-load-next-week">–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è <i class="bi bi-arrow-down"></i></button>

            <div class="ms-auto d-flex align-items-center gap-2">
                <label class="small text-muted mb-0">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–∞—Ç–µ:</label>
                <input type="date" id="jump-date" class="form-control form-control-sm" style="width: 170px;">
                <button class="btn btn-outline-primary btn-sm" id="btn-jump-date">–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å</button>
            </div>
        </div>
    </div>

    <div id="calendar-feed"></div>

    <div id="loading-indicator" class="text-center py-4 d-none">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-muted small mt-2 mb-0">–ü–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–Ω–∏...</p>
    </div>

    <div id="empty-state" class="text-center py-5" style="display: none;">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
            <i class="bi bi-calendar-plus fs-1 text-secondary opacity-50"></i>
        </div>
        <h5 class="fw-bold text-dark">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
        <p class="text-muted mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é.</p>
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createPostModal">
            –°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é
        </button>
    </div>
</div>

<div class="modal fade" id="createPostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">–ù–æ–≤–∞—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="planningPostForm" enctype="multipart/form-data">
                    <input type="hidden" name="tz_offset_minutes" id="modal_tz_offset">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å</label>
                            <input type="date" id="quick-date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">–í—Ä–µ–º—è</label>
                            <input type="time" id="quick-time" class="form-control" value="09:00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                        <input type="datetime-local" name="schedule_date" id="schedule_date_input" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
                        <textarea name="text" class="form-control bg-light" rows="4" placeholder="–û —á–µ–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã</label>
                        <input type="file" name="media" class="form-control" multiple accept="image/*,video/*">
                    </div>

                    <div class="bg-light p-3 rounded-3 mb-4">
                        <label class="form-label small fw-bold text-muted mb-2 d-block">–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:</label>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input" type="checkbox" name="publish_tg" id="chk_tg" {% if telegram_channels %}checked{% else %}disabled{% endif %} onchange="document.getElementById('channel_tg_modal').disabled = !this.checked">
                                    <label class="form-check-label ms-1 fw-bold" for="chk_tg"><i class="bi bi-telegram text-primary"></i> Telegram</label>
                                </div>
                                {% if telegram_channels %}<select name="channel_tg" id="channel_tg_modal" class="form-select form-select-sm" style="width: auto; min-width: 150px;">{% for ch in telegram_channels %}<option value="{{ ch.id }}">{{ ch.name }}</option>{% endfor %}</select>{% endif %}
                            </div>
                            <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input" type="checkbox" name="publish_vk" id="chk_vk" {% if vk_groups %}checked{% else %}disabled{% endif %} onchange="document.getElementById('channel_vk_modal').disabled = !this.checked">
                                    <label class="form-check-label ms-1 fw-bold" for="chk_vk">VK</label>
                                </div>
                                {% if vk_groups %}<select name="channel_vk" id="channel_vk_modal" class="form-select form-select-sm" style="width: auto; min-width: 150px;">{% for g in vk_groups %}<option value="{{ g.id }}">{{ g.name }}</option>{% endfor %}</select>{% endif %}
                            </div>
                            <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input" type="checkbox" name="publish_ok" id="chk_ok" {% if ok_groups %}checked{% else %}disabled{% endif %} onchange="document.getElementById('channel_ok_modal').disabled = !this.checked">
                                    <label class="form-check-label ms-1 fw-bold" for="chk_ok">OK</label>
                                </div>
                                {% if ok_groups %}<select name="channel_ok" id="channel_ok_modal" class="form-select form-select-sm" style="width: auto; min-width: 150px;">{% for g in ok_groups %}<option value="{{ g.id }}">{{ g.name }}</option>{% endfor %}</select>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="btn-save-plan">
                            <span class="spinner-border spinner-border-sm d-none me-2" id="save-spinner"></span>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const feed = document.getElementById('calendar-feed');
    const loader = document.getElementById('loading-indicator');
    const emptyState = document.getElementById('empty-state');
    const jumpDateInput = document.getElementById('jump-date');
    const quickDateInput = document.getElementById('quick-date');
    const quickTimeInput = document.getElementById('quick-time');
    const scheduleInput = document.getElementById('schedule_date_input');

    let rangeStart = startOfWeek(new Date());
    let rangeEnd = addDays(rangeStart, 6);
    const loadedRanges = new Set();

    function toIsoDate(d) {
        return d.toISOString().slice(0, 10);
    }

    function startOfWeek(date) {
        const d = new Date(date);
        const day = (d.getDay() + 6) % 7;
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() - day);
        return d;
    }

    function addDays(date, days) {
        const d = new Date(date);
        d.setDate(d.getDate() + days);
        return d;
    }

    function dayLabel(dateIso) {
        const d = new Date(dateIso + 'T00:00:00');
        return d.toLocaleDateString('ru-RU', { weekday: 'long', day: '2-digit', month: 'long' });
    }

    function renderEmptyDays(startDate, endDate) {
        const blocks = [];
        let cursor = new Date(startDate);
        while (cursor <= endDate) {
            const dayKey = toIsoDate(cursor);
            blocks.push(`
                <section class="card border-0 shadow-sm mb-3 day-block" data-day="${dayKey}">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${dayLabel(dayKey)}</strong>
                            <div class="small text-muted">${dayKey}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary js-plan-day" data-day="${dayKey}"><i class="bi bi-plus"></i> –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å</button>
                    </div>
                    <div class="card-body day-posts text-muted small">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</div>
                </section>
            `);
            cursor = addDays(cursor, 1);
        }
        return blocks.join('');
    }

    function renderPost(post) {
        const media = (post.media && post.media[0]) ? `<div class="small text-muted mb-1">üìé ${post.media.length} –º–µ–¥–∏–∞</div>` : '';
        return `
            <div class="border rounded p-2 mb-2 bg-light">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>${post.time_human}</strong>
                    <span class="badge bg-secondary">scheduled</span>
                </div>
                ${media}
                <div style="white-space: pre-wrap;">${post.text || '<em>–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞</em>'}</div>
            </div>
        `;
    }

    async function loadRange(startDate, endDate, appendMode = 'append') {
        const key = `${toIsoDate(startDate)}_${toIsoDate(endDate)}`;
        if (loadedRanges.has(key)) return;

        loader.classList.remove('d-none');
        try {
            const resp = await fetch(`/api/planning/posts?start_date=${toIsoDate(startDate)}&end_date=${toIsoDate(endDate)}`);
            const data = await resp.json();

            const wrapper = document.createElement('div');
            wrapper.dataset.range = key;
            wrapper.innerHTML = renderEmptyDays(startDate, endDate);

            const grouped = {};
            (data.posts || []).forEach(p => {
                grouped[p.day_key] = grouped[p.day_key] || [];
                grouped[p.day_key].push(p);
            });

            Object.entries(grouped).forEach(([dayKey, posts]) => {
                const dayEl = wrapper.querySelector(`.day-block[data-day="${dayKey}"] .day-posts`);
                if (dayEl) {
                    dayEl.classList.remove('text-muted');
                    dayEl.innerHTML = posts.map(renderPost).join('');
                }
            });

            if (appendMode === 'prepend' && feed.firstChild) {
                feed.prepend(wrapper);
            } else {
                feed.appendChild(wrapper);
            }

            loadedRanges.add(key);
            bindPlanDayButtons();

            if (!feed.querySelector('.day-posts .border')) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞', e);
        } finally {
            loader.classList.add('d-none');
        }
    }

    function setScheduleFromDay(dayIso) {
        const time = quickTimeInput.value || '09:00';
        scheduleInput.value = `${dayIso}T${time}`;
        quickDateInput.value = dayIso;
    }

    function bindPlanDayButtons() {
        document.querySelectorAll('.js-plan-day').forEach(btn => {
            btn.onclick = () => {
                const day = btn.dataset.day;
                setScheduleFromDay(day);
                const modal = new bootstrap.Modal(document.getElementById('createPostModal'));
                modal.show();
            };
        });
    }

    document.getElementById('btn-load-prev-week').addEventListener('click', async () => {
        const newStart = addDays(rangeStart, -7);
        const newEnd = addDays(rangeStart, -1);
        await loadRange(newStart, newEnd, 'prepend');
        rangeStart = newStart;
    });

    document.getElementById('btn-load-next-week').addEventListener('click', async () => {
        const newStart = addDays(rangeEnd, 1);
        const newEnd = addDays(rangeEnd, 7);
        await loadRange(newStart, newEnd, 'append');
        rangeEnd = newEnd;
    });

    document.getElementById('btn-jump-date').addEventListener('click', async () => {
        if (!jumpDateInput.value) return;
        const target = new Date(jumpDateInput.value + 'T00:00:00');
        const start = startOfWeek(target);
        const end = addDays(start, 6);
        await loadRange(start, end, 'append');
        const dayNode = feed.querySelector(`.day-block[data-day="${jumpDateInput.value}"]`);
        if (dayNode) dayNode.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    quickDateInput.addEventListener('change', () => {
        if (!quickDateInput.value) return;
        setScheduleFromDay(quickDateInput.value);
    });

    quickTimeInput.addEventListener('change', () => {
        if (!quickDateInput.value) return;
        setScheduleFromDay(quickDateInput.value);
    });

    const form = document.getElementById('planningPostForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        document.getElementById('modal_tz_offset').value = -new Date().getTimezoneOffset();

        const btn = document.getElementById('btn-save-plan');
        const spinner = document.getElementById('save-spinner');
        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
            const formData = new FormData(form);
            const response = await fetch('/create_post', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.status === 'success') {
                bootstrap.Modal.getOrCreateInstance(document.getElementById('createPostModal')).hide();
                form.reset();
                feed.innerHTML = '';
                loadedRanges.clear();
                await loadRange(rangeStart, rangeEnd, 'append');
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞');
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    });

    const now = new Date();
    const currentDay = toIsoDate(now);
    jumpDateInput.value = currentDay;
    quickDateInput.value = currentDay;
    setScheduleFromDay(currentDay);

    loadRange(rangeStart, rangeEnd, 'append');
});
</script>
{% endblock %}
